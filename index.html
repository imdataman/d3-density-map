<!DOCTYPE html>
<meta http-equiv="Content-Security-Policy" content="default-src *;
   img-src * 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' *;
   style-src  'self' 'unsafe-inline' *">
<style>
.q0-9 {
    fill: rgb(247, 251, 255);
}

.q1-9 {
    fill: rgb(222, 235, 247);
}

.q2-9 {
    fill: rgb(198, 219, 239);
}

.q3-9 {
    fill: rgb(158, 202, 225);
}

.q4-9 {
    fill: rgb(107, 174, 214);
}

.q5-9 {
    fill: rgb(66, 146, 198);
}

.q6-9 {
    fill: rgb(33, 113, 181);
}

.q7-9 {
    fill: rgb(8, 81, 156);
}

.q8-9 {
    fill: rgb(8, 48, 107);
}

.border {
    stroke: white;
    fill: none;
}

.county {
    stroke: white;
    stroke-width: 1;
}
</style>
<svg width="960" height="960"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script>
var svg = d3.select("svg");
var path = d3.geoPath();
var transform = d3.zoomIdentity;

var g4 = svg.append('g');
var g3 = svg.append('g');
var g = svg.append('g');
var g2 = svg.append('g');

var density = d3.map();
var color = d3.scaleThreshold()
    .domain([1, 250, 500, 1000, 2500, 5000, 10000, 20000])
    .range(d3.schemeOrRd[9])

d3.queue()
    .defer(d3.json, "./data/county-quantized-topo.json")
    .defer(d3.json, "./data/town-quantized-topo.json")
    .defer(d3.json, "./data/village-quantized-topo.json")
    .await(ready);

function ready(error, county, town, village) {
    if (error) throw error;
    var countydata = topojson.feature(county, county.objects.tracts).features
    var towndata = topojson.feature(town, town.objects.tracts).features
    var villagedata = topojson.feature(village, village.objects.tracts).features

    var zoom = d3.zoom()
        .scaleExtent([1, 100])
        .on('zoom', zoomed)
        .on("end", zoomEndFunction);

    svg.call(zoom);

    g.selectAll("path")
        .data(countydata)
        .enter().append("path")
        .attr("class", "county")
        .attr("fill", function(d) {
            return color(d.properties.pop);
        })
        .attr("d", path);

    function zoomed() {
        g.selectAll('path')
            .attr('transform', d3.event.transform);
        g2.selectAll('path')
            .attr('transform', d3.event.transform);
        g3.selectAll('path')
            .attr('transform', d3.event.transform);
        g4.selectAll('path')
            .attr('transform', d3.event.transform);

    }

    function zoomEndFunction() {
        transform = d3.event.transform
        if (transform.k > 25) {
            var filteredVillage = villagedata.filter(function(d) {
                var x = d.geometry.coordinates.map(function(i) { return i[0][0] })
                var y = d.geometry.coordinates.map(function(i) { return i[0][1] })
                return ((Math.min(x) > transform.invertX(0) && Math.min(y) > transform.invertY(0)) && (Math.min(x) < transform.invertX(960) && Math.min(y) < transform.invertY(960))) | ((Math.max(x) > transform.invertX(0) && Math.max(y) > transform.invertY(0)) && (Math.max(x) < transform.invertX(960) && Math.max(y) < transform.invertY(960)))
            })
            g.selectAll("path").remove()
            var villagemap = g.selectAll("path")
                .data(filteredVillage)
                .enter().append("path")
                .attr("fill", function(d) {
                    return color(d.properties.pop);
                })
                .attr("d", path)
                .attr('transform', transform)

            var filteredTown = towndata.filter(function(d) {
                var x = d.geometry.coordinates.map(function(i) { return i[0][0] })
                var y = d.geometry.coordinates.map(function(i) { return i[0][1] })
                return (Math.max(x) > transform.invertX(0) && Math.max(y) > transform.invertY(0)) | (Math.min(x) < transform.invertX(960) && Math.min(y) < transform.invertY(960))
            })
            g2.selectAll("path").remove()
            var townmap = g2.selectAll("path")
                .data(filteredTown)
                .enter().append("path")
                .attr("class", "border")
                .attr("d", path)
                .attr("stroke-width", function() { return 2 / transform.k })
                .attr('transform', transform)

            var basemap = g3.selectAll("path")
                .data(filteredTown)
                .enter().append("path")
                .attr("fill", function(d) {
                    return color(d.properties.pop);
                })
                .attr("d", path)
                .attr('transform', transform)

            var basemap2 = g4.selectAll("path")
                .data(countydata)
                .enter().append("path")
                .attr("fill", function(d) {
                    return color(d.properties.pop);
                })
                .attr("d", path)
                .attr('transform', transform)
        } else if (transform.k > 5 && transform.k < 25) {
            g.selectAll("path").remove()
            var townmap = g.selectAll("path")
                .data(towndata)
                .enter().append("path")
                .attr("class", "town")
                .attr("fill", function(d) {
                    return color(d.properties.pop);
                })
                .attr("d", path)
                .attr('transform', transform)

            g2.selectAll("path").remove()
            var countymap = g2.selectAll("path")
                .data(countydata)
                .enter().append("path")
                .attr("class", "border")
                .attr("d", path)
                .attr("stroke-width", function() { return 2 / transform.k })
                .attr('transform', transform)
            g3.selectAll("path").remove()
            g4.selectAll("path").remove()
        } else {
            g.selectAll("path").remove()
            var countymap = g.selectAll("path")
                .data(countydata)
                .enter().append("path")
                .attr("fill", function(d) {
                    return color(d.properties.pop);
                })
                .attr("d", path)
                .attr("stroke", "white")
                .attr("stroke-width", function() { return 2 / transform.k })
                .attr('transform', transform)
            g2.selectAll("path")
                .remove();
            g3.selectAll("path").remove()
            g4.selectAll("path").remove()

        }
    }
};
</script>
